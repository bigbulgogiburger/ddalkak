name: Docker Compose Validation

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'docker-compose.yml'
      - 'docker-compose.development.yml'
      - '.env.example'
      - 'backend/Dockerfile'
      - 'frontend/Dockerfile'
      - '.github/workflows/docker-compose-test.yml'
  pull_request:
    branches: [ master, main, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Create .env file
      run: cp .env.example .env

    - name: Build images
      run: docker-compose build --no-cache

    - name: Validate docker-compose.yml
      run: docker-compose config > /dev/null

    - name: Start services
      run: docker-compose up -d

    - name: Wait for MySQL to be ready
      run: |
        for i in {1..30}; do
          if docker-compose exec -T mysql mysql -u root -ppassword -e "SELECT 1" 2>/dev/null; then
            echo "MySQL is ready!"
            exit 0
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done
        echo "MySQL failed to start"
        exit 1

    - name: Wait for Backend to be ready
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:8080/api/v1/courses/region/서울 2>/dev/null; then
            echo "Backend is ready!"
            exit 0
          fi
          echo "Waiting for Backend... ($i/30)"
          sleep 2
        done
        echo "Backend failed to start"
        docker-compose logs backend
        exit 1

    - name: Test API endpoint
      run: |
        curl -X POST http://localhost:8080/api/v1/courses/recommend \
          -H "Content-Type: application/json" \
          -d '{
            "region": "서울",
            "dateType": "로맨틱",
            "budget": 100000
          }' \
          -f || exit 1

    - name: Check service health
      run: |
        docker-compose ps
        docker-compose logs mysql | tail -20
        docker-compose logs backend | tail -20

    - name: Stop services
      if: always()
      run: docker-compose down -v
